##
## Velocity Template for displaying the WebAuthn user crential registration view
##
## Velocity context will contain the following properties
## flowExecutionUrl - the form action location
## flowRequestContext - the Spring Web Flow RequestContext
## flowExecutionKey - the SWF execution key (this is built into the flowExecutionUrl)
## profileRequestContext - root of context tree
## webauthnRegContext = WebAuthn registration context
## webauthnInlineEnrolmentContext - the inline enrolment context
## encoder - HTMLEncoder class
## webAuthnEncoder - WebAuthnEncoder class
## request - HttpServletRequest
## response - HttpServletResponse
## environment - Spring Environment object for property resolution
## custom - arbitrary object injected by deployer
## registrationInfoMessageFunction - function to produce information message for form
## registrationErrorMessageFunction - function to produce error message for form
##
#set ($debug = $environment.getProperty("idp.authn.webauthn.ui.debug", "false"))

## Add CSP directives
#set ($areYouSure =  "return confirm('#springMessageText('idp.webauthn.register.credential.remove.confirm', 'Are you sure')');")
#set ($nonce = $cspNonce.generateIdentifier())
$response.addHeader("Content-Security-Policy", "default-src 'none'; style-src 'self'; img-src 'self' data:; script-src-elem 'nonce-$nonce'; script-src-attr 'unsafe-hashes' 'sha256-$cspDigester.apply($areYouSure)'")

##
<!DOCTYPE html>
<html>
   <head>
      <title>#springMessageText("idp.title", "Web Login Service")</title>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="refresh" content="300;url=$flowExecutionUrl&_eventId=finish#parse("csrf/csrf-qparam.vm")">      
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
      <script type="text/javascript" src="$request.getContextPath()/js/webauthn/webauthn-support.js" #if ($nonce)nonce="$nonce"#end></script>
      <link rel="stylesheet" type="text/css" href="$request.getContextPath()#springMessageText("idp.css", "/css/placeholder.css" )">
      <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/webauthn.css">
      
      <script type="module" #if ($nonce)nonce="$nonce"#end>
         import {
           parseCreationOptionsFromJSON,
           create,
           supported,
         }  from "$request.getContextPath()/js/webauthn/webauthn-json.browser-ponyfill.min.js";
         
         async function register() {  
             clearMessages();            
             var pkCredOptions = $webAuthnEncoder.serializePublicKeyCredentialOptionsAsJSON($webauthnRegContext.publicKeyCredentialCreationOptions); 
             var pkCredOptionsParsed = parseCreationOptionsFromJSON(pkCredOptions);         
             await create(pkCredOptionsParsed)
                     .then(function (publicKeyCredentialAttestation){
                         var nickname = prompt('#springMessageText("idp.webauthn.register.credential.nickname", "Credential Nickname")');
                         document.getElementById("credentialNickname").value = nickname;
                         document.getElementById("publicKeyCredential").value = JSON.stringify(publicKeyCredentialAttestation);    
                         document.getElementById("registrationSubmit").click();
                     }).catch(function (err){
                         console.error(err);                        
                         document.getElementById("error_div").classList.remove('hidden')
                         document.getElementById("error_message").innerHTML = err.message;                         
                     });   
          };
          
          function clearMessages(){
             if(document.getElementById('error_div') != null){
                document.getElementById('error_div').classList.add('hidden');
             }
               
             if (document.getElementById('reg-error-outcome') != null){
                document.getElementById('reg-error-outcome').classList.add('hidden');
             }
             if (document.getElementById('reg-success-outcome') != null){
                document.getElementById('reg-success-outcome').classList.add('hidden');
             } 
          }
         
          function initButton() {
               document.getElementById("registerButton").onclick = register;        
               return false;
          }
          
          window.addEventListener("load", () => {
                 try {
                   var isSupported = supported();
                   if (!isSupported){
                     document.getElementById('supportedDiv').classList.add('hidden')
                     document.getElementById("supportedDiv").disabled = true;
                     document.getElementById("publicKeyCredentialAttestationForm").disabled = true;        
                     document.getElementById("registrationSubmit").disabled = true;
                     
                     document.getElementById("unsupportedDiv").disabled = false;
                     document.getElementById('unsupportedDiv').classList.remove('hidden')
                   } else{
                     initButton();
                   }     
                 
                 } catch (e) {
                 console.error(e);
                 }
          });    
      </script>      
   </head>
   <body>
      <main class="main">
         <header>
            <img class="main-logo" src="$request.getContextPath()#springMessageText("idp.logo", "/images/placeholder-logo.png" )" alt="#springMessageText(" idp.logo.alt-text", "logo" )" />
         </header>
         <section>
            <div id="supportedDiv">
               <div class="centre">               
                  #set ($infoMessage = $registrationInfoMessageFunction.apply($profileRequestContext))
                  #if ($infoMessage)
                        <p id="reg-success-outcome" class="output-message output--success">$encoder.encodeForHTML($infoMessage)</p>        
                  #end
                  
                  #set ($errorMessage = $registrationErrorMessageFunction.apply($profileRequestContext))
                  #if ($errorMessage)
                        <p id="reg-error-outcome" class="output-message output--error">$encoder.encodeForHTML($errorMessage)</p>        
                  #end
                    
                  <div class="hidden output-message output--error" id="error_div">
                        <p id="error_message"></p>
                  </div>                
                  <div>
                     <h1>#springMessageText("idp.webauthn.register.registered.keys","Registered keys for") '$encoder.encodeForHTML($webauthnRegContext.displayName)'</h1>
                     #if ($webauthnRegContext.existingCredentials)
                         <table>
                            <tr>
                               <th>#springMessageText("idp.webauthn.register.table.header.keyName", "Key Name")</th>                               
                               <th>#springMessageText("idp.webauthn.register.table.header.authenticatorDescription", "Authenticator")</th>
                               <th>#springMessageText("idp.webauthn.register.table.header.authenticatorIcon", "Icon")</th> 
                               <th>#springMessageText("idp.webauthn.register.table.header.labels", "Labels")</th>
                               <th>#springMessageText("idp.webauthn.register.table.header.registrationTime", "Registration Time")</th>
                               <th>#springMessageText("idp.webauthn.register.table.header.action", "Action")</th>
                            </tr>
                            #foreach($cred in $webauthnRegContext.existingCredentials)
                            <tr>
                               <td>$encoder.encodeForHTML($cred.credentialRecord.nickname)</td>                              
                               #if ($cred.authenticatorDescription)
                                   <td>$encoder.encodeForHTML($cred.authenticatorDescription)</td>
                               #else
                                    <td>#springMessageText("idp.webauthn.register.table.unknownCredential", "unknown")</td>
                               #end
                               #if ($cred.icon)
                                    <td> <img class="authenticator-logo" src="$encoder.encodeForHTML($cred.icon)" alt="$encoder.encodeForHTML($cred.credentialRecord.nickname)-authenticator-icon"/></td> 
                               #else
                                    <td></td>
                               #end
                               <td>
                                #foreach($label in $cred.labels)
                                    <span class="label info">$encoder.encodeForHTML($label)</span>
                                #end  
                               </td>                             
                               <td>$encoder.encodeForHTML($webAuthnEncoder.formatInstant($cred.credentialRecord.registrationTime))</td>
                               <td>
                                  <form id="delete_key_form" action="$flowExecutionUrl" method="post">
                                     #parse("csrf/csrf.vm")
                                     <input type="hidden" name="credentialId" value="$cred.credentialRecord.credentialIdBase64Url"/>
                                     <button class="webauthn-table-button" onclick="$areYouSure" id="removeButton" type="submit" name="_eventId_deleteKey">
                                    #springMessageText("idp.webauthn.register.credential.remove", "Remove")</button>
                                  </form>
                               </td>
                            </tr>
                             #end 
                         </table>                                        
                     #else
                        <div><span>#springMessageText("idp.webauthn.register.registered.noKeys", "You have no registered keys")</span></div>
                     #end
                     <br/>
                     <div class="grid">
                        <div class="grid-item">
                            <button id="registerButton">#springMessageText("idp.webauthn.register.addKey", "Add new security key")</button>
                            <form id="finish_button_form" action="$flowExecutionUrl" method="post" class="inline">
                               #parse("csrf/csrf.vm")                           
                                #if ($webauthnInlineEnrolmentContext.ssoUrl)
                                    <button id="finish_button" type="submit" name="_eventId_resume">#springMessageText("idp.webauthn.register.finish.resume", "Resume")</button>
                               #else
                                    <button id="finish_button" type="submit" name="_eventId_finish">#springMessageText("idp.webauthn.register.finish", "Finish")</button>                              
                               #end
                            </form>
                        </div>                        
                     </div>
                    
                     
                     <form id="publicKeyCredentialAttestationForm" action="$flowExecutionUrl" method="post">
                        #parse("csrf/csrf.vm")
                        <input type="hidden" id="credentialNickname" name="credentialNickname"/>
                        <input type="hidden" id="publicKeyCredential" name="publicKeyCredential"/>
                        <button class="hidden" id="registrationSubmit" type="submit" name="_eventId_addKey">#springMessageText("idp.webauthn.register.submit", "Submit Registration")</button>
                     </form>
                  </div>
                  #if($debug == "true")
                      <hr/>
                      <button type="button" class="collapsible-debug">#springMessageText("idp.webauthn.debug.register.title", "Debugging")</button> 
                      <div class="debug" id="debug-div">
                         <label for="publicKeyCredentialCreation">#springMessageText("idp.webauthn.debug.register.request", "Registration Options")</label>
                         <textarea id="publicKeyCredentialCreation" name="publicKeyCredentialCreation" rows="20" cols="50">
                         $webAuthnEncoder.serializePublicKeyCredentialOptionsAsJSON($webauthnRegContext.publicKeyCredentialCreationOptions)</textarea>                   
                      </div>
                  #end            
               </div>
               <div id="unsupportedDiv" class="hidden">
                  #springMessageText("idp.webauthn.register.unsupported", "Your browser is not WebAuthn compatible")
               </div>
            </div>
         </section>
      </main>
      <footer>
         <div class="cc">
            <p class="footer-text">#springMessageText("idp.footer", "Insert your footer text here.")</p>
         </div>
      </footer>
      </div>    
   </body>
</html>